<div class="container-fluid">
  <div class="row vh-100">
    <div class="col-md-4">
      <select name="mycity" id="mycity" class="form-select form-select-lg mt-4">
        <option value="" selected disabled>---選擇縣市名稱---</option>
        <option value="台中市">台中市</option>
        <option value="台北市">台北市</option>
        <option value="台南市">台南市</option>
      </select>
      <select name="myarea" id="myarea" class="form-select form-select-lg mt-3">
        <option value="" selected disabled>---選擇鄉鎮區名稱---</option>
        <option value="南屯區">南屯區</option>
        <option value="北屯區">北屯區</option>
        <option value="西屯區">西屯區</option>
      </select>
      <ul
        class="list-group mt-3"
        id="mylist"
        style="height: 80vh; overflow: scroll"
      >
      </ul>
    </div>
    <div class="col-md-8">
      <div id="map" class="vh-100"></div>
    </div>
  </div>
</div>

<script>
  var allCityData;
  var hotelpoints;
  var mycity;
  var myarea;
  var map;
  var markers;
  var dbData = [];
  $(document).ready(function () {
    $("#banner").load("banner.html");
  });
  $(function () {
    map = L.map("map").setView([24.171642, 120.609483], 13);

    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    markers = new L.markerClusterGroup().addTo(map);
    $.ajax({
      type: "GET",
      url: "http://192.168.10.73/peso/all/newproject/member_control_api_v1.php?action=storedata",
      dataType: "json",
      async: false,
      success: function (data) {
        hotelpoints = data.data;
      },
      error: function () {
        Swal.fire({
          title: "API介接錯誤?",
          text: "http://192.168.10.73/peso/all/newproject/member_control_api_v1.php?action=storedata",
          icon: "error",
        });
      },
    });

    $("#mycity").empty();
    $("#mycity").append(
      '<option value="" selected disabled>---選擇縣市名稱---</option>'
    );
    hotelpoints.forEach(function (item) {
      dbData = item.area;

      if ($("#mycity option[value='" + item.city + "']").length === 0) {
        var strHTML = `<option value="${item.city}">${item.city}</option>`;
        $("#mycity").append(strHTML);
      }
    });

    $("#mycity").change(function () {
      mycity = $(this).val();

      hotelpoints.forEach(function (item) {
        if (item.city == mycity) {
          $("#myarea").empty();
          $("#myarea").append(
            '<option value="" selected disabled>---選擇鄉鎮區名稱---</option>'
          );
          console.log(item.area);
          var strHTML = `<option value="${item.area}">${item.area}</option>`;
          $("#myarea").append(strHTML);
        }
      });
    });

    $("#myarea").change(function () {
      removeMarker();

      myarea = $(this).val();

      $("#mylist").empty();
      var counter = 0;
      hotelpoints.forEach(function (item) {
        if (item.city == mycity && item.area == myarea) {
          console.log(item);
          counter++;
          if (counter == 1) {
            map.panTo([item.latitude, item.longitude]);
          }
          var img = item.photo;
          if (item.photo == "") {
            img = "https://fakeimg.pl/958x485/BB0?text=working...";
          }
          var strHTML = `
              <li class="list-group-item" data-img="${img}" data-name="${item.name}" data-address="${item.address}" data-tel="${item.tel}" data-lat="${item.latitude}" data-lng="${item.longitude}">
                <div class="row d-flex">
                  <div class="col-md-4 text-center">
                    <img src="${img}" class="img-thumbnail" style="max-height: 125px;" alt="" />
                  </div>
                  <div class="col-md-8">
                    <p class="h3 fw-900 text-danger">${item.name}</p>
                    <p class="h5 fw-900">地址:${item.address}</p>
                    <p class="h5 fw-900">電話:${item.tel}</p>
                  </div>
                </div>
              </li>
              `;
          $("#mylist").append(strHTML);

          var popupHTML = `
                                <div class="card" style="width: 18rem;">
                                  <img src="${img}" class="card-img-top" alt="...">
                                  <div class="card-body">
                                    <h5 class="card-title">${item.name}</h5>
                                    <p class="card-text h5 fw-900">地址:${item.address}</p>
                                    <p class="card-text h5 fw-900">電話:${item.tel}</p>
                                  </div>
                                </div>
                              `;
          markers.addLayer(
            L.marker([item.latitude, item.longitude], {
              icon: IIcon,
            }).bindPopup(popupHTML)
          );
        }
      });

      $("#mylist .list-group-item").click(function () {

        markerPopup(
          $(this).data("img"),
          $(this).data("name"),
          $(this).data("address"),
          $(this).data("tel"),
          $(this).data("lat"),
          $(this).data("lng")
        );
      });
    });
  });


  var markersData = [];

  function markerPopup(img, name, address, tel, lat, lng) {
    var popupHTML = `
    <div class="card" style="width: 18rem;">
      <img src="${img}" class="card-img-top" alt="...">
      <div class="card-body">
        <h5 class="card-title">${name}</h5>
        <p class="card-text h5 fw-900">地址: ${address}</p>
        <p class="card-text h5 fw-900">電話: ${tel}</p>
      </div>
    </div>`;

    var marker = L.marker([lat, lng], { icon: greenIcon }).bindPopup(popupHTML);

    markers.addLayer(marker);

    markersData.push(marker);
  }

  function removeMarker() {
    markersData.forEach(function (marker) {
      markers.removeLayer(marker);
    });
    markers.clearLayers();
    markersData = [];
  }
</script>
